<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Converter API</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #0066cc;
            margin-top: 0;
        }
        input[type="file"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px dashed #ccc;
            border-radius: 5px;
            background-color: white;
        }
        select, button {
            padding: 12px 20px;
            margin: 10px 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #0066cc;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0052a3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .progress {
            display: none;
            margin: 20px 0;
            padding: 15px;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .success {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
        }
        .transcription {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Video Converter API</h1>

        <!-- Video to Audio Section -->
        <div class="section">
            <h2>üéµ Video to Audio</h2>
            <input type="file" id="audioVideoFile" accept="video/*" />
            <select id="audioFormat">
                <option value="mp3">MP3 (High Quality)</option>
                <option value="wav">WAV (Lossless)</option>
                <option value="aac">AAC (Efficient)</option>
                <option value="flac">FLAC (Lossless)</option>
                <option value="ogg">OGG (Open Source)</option>
            </select>
            <button onclick="convertToAudio()" id="audioBtn">Convert to Audio</button>
            
            <div id="audioProgress" class="progress">
                <strong>Converting video to audio...</strong><br>
                This may take a few moments depending on the video size.
            </div>
            <div id="audioResult"></div>
        </div>

        <!-- Video to Text Section -->
        <div class="section">
            <h2>üìù Video to Text (Speech Recognition)</h2>
            <input type="file" id="textVideoFile" accept="video/*" />
            <button onclick="convertToText()" id="textBtn">Convert to Text</button>
            
            <div id="textProgress" class="progress">
                <strong>Converting speech to text...</strong><br>
                This process uses AI and may take longer for videos with lots of speech.
            </div>
            <div id="textResult"></div>
        </div>
    </div>

    <script>
        // Dynamic base URL - works locally and in production
        const baseUrl = window.location.origin + '/api/videoconverter';
        
        // Global variables to store transcription data
        let originalTranscription = '';
        let showTimestamps = true;

        async function convertToAudio() {
            const fileInput = document.getElementById('audioVideoFile');
            const format = document.getElementById('audioFormat').value;
            const btn = document.getElementById('audioBtn');
            const progress = document.getElementById('audioProgress');
            const result = document.getElementById('audioResult');

            if (!fileInput.files[0]) {
                alert('Please select a video file first.');
                return;
            }

            btn.disabled = true;
            progress.style.display = 'block';
            result.innerHTML = '';

            const formData = new FormData();
            formData.append('videoFile', fileInput.files[0]);
            formData.append('format', format);

            try {
                const response = await fetch(`${baseUrl}/audio`, {
                    method: 'POST',
                    body: formData
                });

                progress.style.display = 'none';

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const fileName = (fileInput.files[0]?.name || 'converted_file').replace(/\.[^/.]+$/, '') + `.${format}`;
                    
                    result.innerHTML = `
                        <div class="result success">
                            <strong>‚úì Conversion Successful!</strong><br>
                            <audio controls style="width: 100%; margin: 10px 0;">
                                <source src="${url}" type="audio/${format}">
                                Your browser does not support the audio element.
                            </audio>
                            <br>
                            <a href="${url}" download="${fileName}" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 5px;">
                                üì• Download ${format.toUpperCase()} File
                            </a>
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    result.innerHTML = `<div class="result error"><strong>‚úó Conversion Failed:</strong><br>${error}</div>`;
                }
            } catch (error) {
                progress.style.display = 'none';
                result.innerHTML = `<div class="result error"><strong>‚úó Error:</strong><br>${error.message}</div>`;
            }

            btn.disabled = false;
        }

        async function convertToText() {
            const fileInput = document.getElementById('textVideoFile');
            const btn = document.getElementById('textBtn');
            const progress = document.getElementById('textProgress');
            const result = document.getElementById('textResult');

            if (!fileInput.files[0]) {
                alert('Please select a video file first.');
                return;
            }

            btn.disabled = true;
            progress.style.display = 'block';
            result.innerHTML = '';

            const formData = new FormData();
            formData.append('videoFile', fileInput.files[0]);

            try {
                const response = await fetch(`${baseUrl}/text`, {
                    method: 'POST',
                    body: formData
                });

                progress.style.display = 'none';

                if (response.ok) {
                    const data = await response.json();
                    
                    // Store original transcription for toggle functionality
                    originalTranscription = data.transcription || '';
                    showTimestamps = true;
                    
                    // Debug: Log the actual response data
                    console.log('API Response:', data);
                    console.log('Transcription field:', data.transcription);
                    console.log('Transcription length:', data.transcription?.length);
                    
                    // Check if transcription exists and is valid
                    if (!data.transcription || data.transcription.trim() === '') {
                        result.innerHTML = '<div class="result error">‚ùå No transcription data received from server</div>';
                        return;
                    }
                    
                    // Create downloadable text file
                    const textBlob = new Blob([data.transcription], { type: 'text/plain' });
                    const textUrl = window.URL.createObjectURL(textBlob);
                    const fileName = (fileInput.files[0]?.name || 'transcription').replace(/\.[^/.]+$/, '') + '_transcription.txt';
                    
                    result.innerHTML = `
                        <div class="result success">
                            <strong>‚úì Speech Recognition Successful!</strong><br>
                            <strong>File:</strong> ${data.fileName}<br>
                            <strong>Words Found:</strong> ${data.wordCount}<br>
                            <strong>Processed At:</strong> ${new Date(data.processedAt).toLocaleString()}<br>
                            
                            <div style="margin: 15px 0;">
                                <a href="${textUrl}" download="${fileName}" style="display: inline-block; padding: 10px 20px; background-color: #2196F3; color: white; text-decoration: none; border-radius: 5px; margin-right: 10px;">
                                    üìÑ Download Text File
                                </a>
                                <button id="copyBtn" onclick="copyCurrentText()" style="padding: 10px 20px; background-color: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                                    üìã Copy to Clipboard
                                </button>
                                <button id="toggleTimestamps" onclick="toggleTimestamps()" style="padding: 10px 20px; background-color: #9C27B0; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üïê Remove Timestamps
                                </button>
                            </div>
                            
                            <strong>Transcription Preview:</strong>
                            <div id="transcriptionDisplay" class="transcription">${data.transcription || 'No transcription available'}</div>
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    result.innerHTML = `<div class="result error"><strong>‚úó Conversion Failed:</strong><br>${error}</div>`;
                }
            } catch (error) {
                progress.style.display = 'none';
                result.innerHTML = `<div class="result error"><strong>‚úó Error:</strong><br>${error.message}</div>`;
            }

            btn.disabled = false;
        }

        function copyCurrentText() {
            const transcriptionDisplay = document.getElementById('transcriptionDisplay');
            if (!transcriptionDisplay) {
                alert('No transcription available to copy.');
                return;
            }

            const textToCopy = transcriptionDisplay.textContent || transcriptionDisplay.innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const copyBtn = document.getElementById('copyBtn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '‚úì Copied!';
                copyBtn.style.backgroundColor = '#4CAF50';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.style.backgroundColor = '#FF9800';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy to clipboard. Please try again.');
            });
        }

        function removeTimestamps(text) {
            // Remove timestamp patterns like [00:00:00 - 00:00:07] or similar
            return text.replace(/\[\d{2}:\d{2}:\d{2}\s*-\s*\d{2}:\d{2}:\d{2}\]\s*/g, '')
                      .replace(/\r\n/g, ' ')
                      .replace(/\n/g, ' ')
                      .replace(/\s+/g, ' ')
                      .trim();
        }

        function toggleTimestamps() {
            const transcriptionDisplay = document.getElementById('transcriptionDisplay');
            const toggleBtn = document.getElementById('toggleTimestamps');
            
            if (!transcriptionDisplay || !originalTranscription) {
                alert('No transcription available.');
                return;
            }

            showTimestamps = !showTimestamps;
            
            if (showTimestamps) {
                transcriptionDisplay.textContent = originalTranscription;
                toggleBtn.innerHTML = 'üïê Remove Timestamps';
                toggleBtn.style.backgroundColor = '#9C27B0';
            } else {
                const cleanText = removeTimestamps(originalTranscription);
                transcriptionDisplay.textContent = cleanText;
                toggleBtn.innerHTML = 'üïê Show Timestamps';
                toggleBtn.style.backgroundColor = '#795548';
            }
        }

        // Get local IP for mobile access
        function getLocalIP() {
            return new Promise((resolve) => {
                const rtc = new RTCPeerConnection({iceServers: []});
                rtc.createDataChannel('', {ordered: false, maxRetransmits: 0});
                
                rtc.onicecandidate = (evt) => {
                    if (evt.candidate) {
                        const ip = evt.candidate.candidate.split(' ')[4];
                        if (ip && ip !== '0.0.0.0') {
                            resolve(ip);
                        }
                    }
                };
                
                rtc.createOffer().then(offer => rtc.setLocalDescription(offer));
                
                setTimeout(() => resolve('localhost'), 2000);
            });
        }

        // Update mobile access info
        getLocalIP().then(ip => {
            if (ip !== 'localhost') {
                document.getElementById('baseUrl').innerHTML = `
                    <strong>Desktop:</strong> http://localhost:5000<br>
                    <strong>Mobile:</strong> http://${ip}:5000
                `;
            }
        });
    </script>
</body>
</html>